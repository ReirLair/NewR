<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Player Store | Football Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4a6bff;
      --secondary: #ff6b4a;
      --dark: #1a1a2e;
      --light: #f8f9fa;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7ff;
      color: var(--dark);
      line-height: 1.6;
      padding: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: linear-gradient(135deg, var(--primary), #3a56d8);
      color: white;
      padding: 20px 0;
      box-shadow: var(--box-shadow);
      margin-bottom: 30px;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      font-size: 2rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h1 svg {
      width: 28px;
      height: 28px;
    }

    .coin-display {
      background-color: rgba(255, 255, 255, 0.2);
      padding: 8px 16px;
      border-radius: 50px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .coin-display svg {
      width: 20px;
      height: 20px;
    }

    .search-container {
      margin-bottom: 30px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 20px;
      padding-left: 45px;
      border: 2px solid #e0e0e0;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.2);
    }

    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #888;
    }

    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    .filter-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }

    .filter-select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: var(--border-radius);
      background-color: white;
      font-size: 1rem;
      transition: var(--transition);
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .position-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .position-tab {
      padding: 8px 16px;
      background-color: white;
      border: 1px solid #e0e0e0;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }

    .position-tab:hover {
      background-color: #f0f0f0;
    }

    .position-tab.active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .player-card {
      background-color: white;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
      border: 1px solid #e0e0e0;
    }

    .player-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .player-header {
      background: linear-gradient(135deg, var(--primary), #3a56d8);
      color: white;
      padding: 15px;
      position: relative;
    }

    .player-position {
      position: absolute;
      top: 15px;
      right: 15px;
      background-color: rgba(255, 255, 255, 0.2);
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .player-name {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .player-id {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .player-body {
      padding: 15px;
    }

    .player-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #666;
    }

    .stat-value {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .rating {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary);
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 10px;
    }

    .player-footer {
      padding: 15px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .player-price {
      font-weight: bold;
      font-size: 1.2rem;
      color: var(--primary);
    }

    .buy-btn {
      padding: 8px 16px;
      background-color: var(--success);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .buy-btn:hover {
      background-color: #218838;
      transform: translateY(-2px);
    }

    .buy-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .no-results {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .login-warning {
      background-color: var(--danger);
      color: white;
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .login-warning svg {
      width: 20px;
      height: 20px;
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }
      
      .players-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Rating colors */
    .rating-90 { background-color: #ff6b4a; }
    .rating-80 { background-color: #ff9e4a; }
    .rating-70 { background-color: #ffcc4a; }
    .rating-60 { background-color: #4a6bff; }
    .rating-50 { background-color: #4a8bff; }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <h1>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.59-12.42L10 14.17l-2.59-2.58L6 13l4 4 8-8z"/>
        </svg>
        Player Transfer Market
      </h1>
      <div class="coin-display" id="coinDisplay">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/>
        </svg>
        <span>Loading coins...</span>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="loginWarning" class="login-warning" style="display: none;">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
      </svg>
      <span>You must be logged in to purchase players</span>
    </div>

    <div class="search-container">
      <i class="fas fa-search search-icon"></i>
      <input type="text" class="search-input" id="searchInput" placeholder="Search players by name..." autocomplete="off">
    </div>

    <div class="filters">
      <div class="filter-group">
        <label for="positionFilter" class="filter-label">Position</label>
        <select id="positionFilter" class="filter-select">
          <option value="all">All Positions</option>
          <option value="cf">Center Forward</option>
          <option value="lwf">Left Wing Forward</option>
          <option value="rwf">Right Wing Forward</option>
          <option value="mf">Midfielder</option>
          <option value="df">Defender</option>
          <option value="gk">Goalkeeper</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="ratingFilter" class="filter-label">Rating</label>
        <select id="ratingFilter" class="filter-select">
          <option value="all">All Ratings</option>
          <option value="90+">90+</option>
          <option value="80-89">80-89</option>
          <option value="70-79">70-79</option>
          <option value="60-69">60-69</option>
          <option value="50-59">50-59</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="priceFilter" class="filter-label">Price</label>
        <select id="priceFilter" class="filter-select">
          <option value="all">All Prices</option>
          <option value="0-5000">Under 500</option>
          <option value="5000-10000">500-1000</option>
          <option value="10000+">1000+</option>
        </select>
      </div>
    </div>

    <div class="position-tabs">
      <div class="position-tab active" data-position="all">All</div>
      <div class="position-tab" data-position="cf">CF</div>
      <div class="position-tab" data-position="lwf">LWF</div>
      <div class="position-tab" data-position="rwf">RWF</div>
      <div class="position-tab" data-position="mf">MF</div>
      <div class="position-tab" data-position="df">DF</div>
      <div class="position-tab" data-position="gk">GK</div>
    </div>

    <div class="players-grid" id="playerList">
      <!-- Players will be loaded here -->
    </div>
  </main>

  <script>
    const playerName = JSON.parse(localStorage.getItem('user'))?.playerName;
    let userCoins = 0;
    let allPlayers = [];
    const positionMap = {
      'cf': 'Center Forward',
      'lwf': 'Left Wing Forward',
      'rwf': 'Right Wing Forward',
      'mf': 'Midfielder',
      'df': 'Defender',
      'gk': 'Goalkeeper'
    };

    // DOM elements
    const coinDisplay = document.getElementById('coinDisplay');
    const loginWarning = document.getElementById('loginWarning');
    const searchInput = document.getElementById('searchInput');
    const positionFilter = document.getElementById('positionFilter');
    const ratingFilter = document.getElementById('ratingFilter');
    const priceFilter = document.getElementById('priceFilter');
    const positionTabs = document.querySelectorAll('.position-tab');
    const playerList = document.getElementById('playerList');

    // Check login status
    if (!playerName) {
      coinDisplay.querySelector('span').textContent = 'Not logged in';
      loginWarning.style.display = 'flex';
    } else {
      fetch(`/team/${playerName}`)
        .then(res => res.json())
        .then(team => {
          userCoins = team.coins || 0;
          coinDisplay.querySelector('span').textContent = `${userCoins.toLocaleString()} coins`;
        })
        .catch(() => {
          coinDisplay.querySelector('span').textContent = 'Error loading coins';
        });
    }

    // Load players
    fetch('/players.json')
      .then(res => res.json())
      .then(data => {
        allPlayers = [];
        for (const [position, players] of Object.entries(data.players)) {
          players.forEach(player => {
            if (player.rating < 89) { // Exclude players with rating >= 91
              allPlayers.push({
                ...player,
                position,
                price: player.rating * 100
              });
            }
          });
        }
        renderPlayers(allPlayers);
      })
      .catch(error => {
        console.error('Error loading players:', error);
        playerList.innerHTML = '<div class="no-results">Error loading players. Please try again later.</div>';
      });

    // Render players function
    function renderPlayers(players) {
      if (players.length === 0) {
        playerList.innerHTML = '<div class="no-results">No players found matching your criteria</div>';
        return;
      }

      playerList.innerHTML = '';
      
      players.forEach(player => {
        const canAfford = playerName && userCoins >= player.price;
        const ratingClass = `rating-${Math.floor(player.rating / 10) * 10}`;
        
        const card = document.createElement('div');
        card.className = 'player-card';
        card.dataset.position = player.position;
        card.dataset.rating = player.rating;
        card.dataset.price = player.price;
        card.innerHTML = `
          <div class="player-header">
            <div class="player-position">${player.position.toUpperCase()}</div>
            <div class="player-name">${player.name}</div>
            <div class="player-id">ID: ${player.id}</div>
          </div>
          <div class="player-body">
            <div class="${ratingClass} rating">${player.rating}</div>
            <div class="player-stats">
              <div class="stat-item">
                <span class="stat-label">Position</span>
                <span class="stat-value">${positionMap[player.position] || player.position.toUpperCase()}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Age</span>
                <span class="stat-value">${player.age || 'N/A'}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Nationality</span>
                <span class="stat-value">${player.nationality || 'N/A'}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Club</span>
                <span class="stat-value">${player.club || 'N/A'}</span>
              </div>
            </div>
          </div>
          <div class="player-footer">
            <div class="player-price">${player.price.toLocaleString()} coins</div>
            <button class="buy-btn" ${canAfford ? '' : 'disabled'} 
              onclick="confirmBuy(${player.id}, ${player.price}, '${player.name.replace(/'/g, "\\'")}')">
              <i class="fas fa-shopping-cart"></i>
              ${canAfford ? 'Buy Now' : 'Need Coins'}
            </button>
          </div>
        `;
        playerList.appendChild(card);
      });
    }

    // Filter players based on search and filters
    function filterPlayers() {
      const searchTerm = searchInput.value.toLowerCase();
      const position = positionFilter.value;
      const rating = ratingFilter.value;
      const price = priceFilter.value;
      
      const filtered = allPlayers.filter(player => {
        // Search term
        if (searchTerm && !player.name.toLowerCase().includes(searchTerm)) {
          return false;
        }
        
        // Position filter
        if (position !== 'all' && player.position !== position) {
          return false;
        }
        
        // Rating filter
        if (rating !== 'all') {
          if (rating === '89+' && player.rating < 80) return false;
          if (rating === '80-88' && (player.rating < 80 || player.rating > 89)) return false;
          if (rating === '70-79' && (player.rating < 70 || player.rating > 79)) return false;
          if (rating === '60-69' && (player.rating < 60 || player.rating > 69)) return false;
          if (rating === '50-59' && (player.rating < 50 || player.rating > 59)) return false;
        }
        
        // Price filter
        if (price !== 'all') {
          if (price === '0-5000' && player.price > 5000) return false;
          if (price === '5000-10000' && (player.price < 5000 || player.price > 1000)) return false;
          if (price === '10000+' && player.price < 10000) return false;
        }
        
        return true;
      });
      
      renderPlayers(filtered);
    }

    // Event listeners
    searchInput.addEventListener('input', filterPlayers);
    positionFilter.addEventListener('change', filterPlayers);
    ratingFilter.addEventListener('change', filterPlayers);
    priceFilter.addEventListener('change', filterPlayers);

    // Position tabs
    positionTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        positionTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        positionFilter.value = tab.dataset.position;
        filterPlayers();
      });
    });

    // Buy player function
    function confirmBuy(id, amount, name) {
      if (!playerName) {
        alert("You must be logged in to purchase players!");
        return;
      }

      if (userCoins < amount) {
        alert("You don't have enough coins for this purchase!");
        return;
      }

      if (confirm(`Are you sure you want to buy ${name} for ${amount.toLocaleString()} coins?`)) {
        buyPlayer(id, amount);
      }
    }

    function buyPlayer(id, amount) {
      fetch('/add-sub', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playerName, newPlayerId: id, amount })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert("Error: " + data.error);
        } else {
          alert(`Success! ${data.message}`);
          // Update coin display
          userCoins -= amount;
          coinDisplay.querySelector('span').textContent = `${userCoins.toLocaleString()} coins`;
          // Update buy buttons
          document.querySelectorAll('.buy-btn').forEach(btn => {
            const price = parseInt(btn.parentElement.querySelector('.player-price').textContent.replace(/,/g, ''));
            btn.disabled = userCoins < price;
            btn.innerHTML = `<i class="fas fa-shopping-cart"></i> ${userCoins >= price ? 'Buy Now' : 'Need Coins'}`;
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert("An error occurred during the purchase. Please try again.");
      });
    }
  </script>
</body>
</html>